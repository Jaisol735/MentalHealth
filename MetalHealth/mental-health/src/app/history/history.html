<app-navbar></app-navbar>

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
          <h1 class="h3 mb-1">
            <i class="fas fa-history me-2 text-primary"></i>
            Assessment History
          </h1>
          <p class="text-muted mb-0">View your past mental health assessments and track your progress</p>
        </div>
        <div>
          <button class="btn btn-outline-secondary me-2" (click)="goBack()">
            <i class="fas fa-arrow-left me-2"></i>Back to Profile
          </button>
          <button class="btn btn-primary" (click)="downloadReport()">
            <i class="fas fa-download me-2"></i>Download Report
          </button>
        </div>
      </div>


      <!-- Loading State -->
      <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading your assessment history...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error && !loading" class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ error }}
        <button class="btn btn-sm btn-outline-danger ms-3" (click)="loadAssessmentHistory()">
          <i class="fas fa-redo me-1"></i>Retry
        </button>
      </div>

      <!-- No Assessments -->
      <div *ngIf="!loading && !error && assessments.length === 0" class="text-center py-5">
        <div class="mb-4">
          <i class="fas fa-clipboard-list text-muted" style="font-size: 4rem;"></i>
        </div>
        <h4 class="text-muted mb-3">No Assessments Yet</h4>
        <p class="text-muted mb-4">You haven't completed any mental health assessments yet.</p>
        <button class="btn btn-primary" (click)="goToHome()">
          <i class="fas fa-plus me-2"></i>Take Your First Assessment
        </button>
      </div>

      <!-- Assessment List - EXACT Same Format as Home Page -->
      <div *ngIf="!loading && !error && assessments.length > 0" class="row">
        <div class="col-12">
          <h4 class="mb-4">
            <i class="fas fa-history me-2 text-primary"></i>
            Your Assessment History ({{ assessments.length }})
          </h4>
          
          <!-- Display each assessment in EXACT same format as home page -->
          <div *ngFor="let assessment of assessments; let i = index" class="mb-4">
            <div class="card hover-lift">
              <div class="card-header gradient-success text-white position-relative overflow-hidden">
                <div class="header-pattern"></div>
                <div class="position-relative">
                  <h5 class="mb-2 fw-bold">
                    <i class="fas fa-check-circle me-2"></i>Assessment #{{ i + 1 }}
                  </h5>
                  <small class="opacity-75">{{ assessment.createdAt | date:'medium' }}</small>
                </div>
              </div>
              <div class="card-body p-4">
                <!-- AI Analysis Results -->
                <div class="analysis-section mb-4">
                  <div class="d-flex align-items-center mb-3">
                    <div class="icon-circle-sm bg-primary text-white me-3">
                      <i class="fas fa-brain"></i>
                    </div>
                    <h6 class="text-primary mb-0 fw-bold">AI Analysis Summary</h6>
                  </div>
                  <div class="alert alert-info">
                    <p class="mb-0 fw-medium">{{ assessment.aiAnalysis?.summary || 'No summary available' }}</p>
                  </div>
                </div>

                <!-- Risk Level -->
                <div class="risk-section mb-4">
                  <div class="d-flex align-items-center mb-3">
                    <div class="icon-circle-sm bg-warning text-white me-3">
                      <i class="fas fa-shield-alt"></i>
                    </div>
                    <h6 class="text-primary mb-0 fw-bold">Risk Assessment</h6>
                  </div>
                  <div class="alert" [ngClass]="{
                    'alert-success': assessment.aiAnalysis?.riskLevel === 'Low',
                    'alert-warning': assessment.aiAnalysis?.riskLevel === 'Medium',
                    'alert-danger': assessment.aiAnalysis?.riskLevel === 'High'
                  }">
                    <div class="d-flex align-items-center">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      <strong>Risk Level: </strong>
                      <span class="ms-2 fw-bold" [ngClass]="getRiskLevelClass(assessment.aiAnalysis?.riskLevel)">
                        {{ assessment.aiAnalysis?.riskLevel || 'Unknown' }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Recommendations -->
                <div class="recommendations-section mb-4">
                  <div class="d-flex align-items-center mb-3">
                    <div class="icon-circle-sm bg-info text-white me-3">
                      <i class="fas fa-lightbulb"></i>
                    </div>
                    <h6 class="text-primary mb-0 fw-bold">Recommendations</h6>
                  </div>
                  <div class="alert alert-light">
                    <div *ngIf="isArray(assessment.aiAnalysis?.recommendations)">
                      <ul class="mb-0 list-unstyled">
                        <li *ngFor="let rec of getRecommendationsAsArray(assessment.aiAnalysis?.recommendations)" 
                            class="d-flex align-items-start mb-2">
                          <i class="fas fa-arrow-right text-primary me-2 mt-1"></i>
                          <span>{{ rec }}</span>
                        </li>
                      </ul>
                    </div>
                    <p *ngIf="!isArray(assessment.aiAnalysis?.recommendations)" class="mb-0 fw-medium">
                      {{ assessment.aiAnalysis?.recommendations || 'No recommendations available' }}
                    </p>
                  </div>
                </div>

                <!-- Your Answers Summary -->
                <div class="answers-summary">
                  <div class="d-flex align-items-center mb-3">
                    <div class="icon-circle-sm bg-secondary text-white me-3">
                      <i class="fas fa-clipboard-list"></i>
                    </div>
                    <h6 class="text-primary mb-0 fw-bold">Your Responses</h6>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="response-item">
                        <div class="response-label">Mood</div>
                        <div class="response-value">{{ assessment.answers.mood }}</div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="response-item">
                        <div class="response-label">Stress Level</div>
                        <div class="response-value">{{ assessment.answers.stressLevel }}/10</div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="response-item">
                        <div class="response-label">Mood Level</div>
                        <div class="response-value">{{ assessment.answers.moodLevel }}/10</div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="response-item">
                        <div class="response-label">Sleep Hours</div>
                        <div class="response-value">{{ assessment.answers.sleepHours }}h</div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="response-item">
                        <div class="response-label">Anxiety</div>
                        <div class="response-value">{{ assessment.answers.anxietyFrequency }}</div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="response-item">
                        <div class="response-label">Overwhelmed</div>
                        <div class="response-value">{{ assessment.answers.overwhelmedFrequency }}</div>
                      </div>
                    </div>
                    <div class="col-md-6" *ngIf="assessment.answers.wantsSummary && assessment.answers.todaySummary">
                      <div class="response-item">
                        <div class="response-label">Today's Summary</div>
                        <div class="response-value">{{ assessment.answers.todaySummary }}</div>
                      </div>
                    </div>
                    <div class="col-md-6" *ngIf="assessment.answers.wantsInstagramAnalysis && assessment.answers.instagramAnalysis">
                      <div class="response-item">
                        <div class="response-label">Instagram Analysis</div>
                        <div class="response-value">{{ assessment.answers.instagramAnalysis }}</div>
                      </div>
                    </div>
                    <div class="col-md-6" *ngIf="assessment.answers.commonFeeling">
                      <div class="response-item">
                        <div class="response-label">Common Feeling</div>
                        <div class="response-value">{{ assessment.answers.commonFeeling }}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Progress Insights -->
      <div *ngIf="!loading && !error && assessments.length > 1" class="row mt-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>
                Recent Trends
              </h6>
            </div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-4">
                  <div class="small text-muted">Avg Stress</div>
                  <div class="h5 mb-0">
                    {{ averageStress.toFixed(1) }}/10
                  </div>
                </div>
                <div class="col-4">
                  <div class="small text-muted">Avg Mood</div>
                  <div class="h5 mb-0">
                    {{ averageMood.toFixed(1) }}/10
                  </div>
                </div>
                <div class="col-4">
                  <div class="small text-muted">Avg Sleep</div>
                  <div class="h5 mb-0">
                    {{ averageSleep.toFixed(1) }}h
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-heart me-2"></i>
                Risk Level Distribution
              </h6>
            </div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-4">
                  <div class="small text-muted">Low Risk</div>
                  <div class="h5 mb-0 text-success">
                    {{ lowRiskCount }}
                  </div>
                </div>
                <div class="col-4">
                  <div class="small text-muted">Medium Risk</div>
                  <div class="h5 mb-0 text-warning">
                    {{ mediumRiskCount }}
                  </div>
                </div>
                <div class="col-4">
                  <div class="small text-muted">High Risk</div>
                  <div class="h5 mb-0 text-danger">
                    {{ highRiskCount }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
